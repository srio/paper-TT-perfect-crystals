%------------------------------------------------------------------------------
% Template file for the submission of papers to IUCr journals in LaTeX2e
% using the iucr document class
% Copyright 1999-2013 International Union of Crystallography
% Version 1.6 (28 March 2013)
%------------------------------------------------------------------------------

% \documentclass{iucr}
\documentclass[preprint]{iucr}              % DO NOT DELETE THIS LINE
\usepackage{bm}
% \usepackage{graphicx}
% \usepackage{tabularx}
% \usepackage{subfigure}
% \usepackage{afterpage}
% \usepackage{sansmath}
\usepackage{mathtools}
% \usepackage{parskip}
% \usepackage{tikz}
% \usepackage{tikzorbital}
% \usepackage{setspace}
% \usepackage{xcolor}
\usepackage{amssymb}
% \usepackage{bm}
\usepackage{amsmath}
% \usepackage{fancyhdr}
% \usepackage{rotating}
\usepackage{siunitx}
\usepackage[hyphens,spaces,obeyspaces]{url}
\usepackage{color}
\usepackage{siunitx}
\usepackage[hyphens,spaces,obeyspaces]{url}
\usepackage{color}
%\usepackage{cprotect}
\usepackage{textgreek}
\usepackage[normalem]{ulem}
\usepackage{makecell}
\usepackage{cancel}
\usepackage{empheq}
\usepackage[usenames,dvipsnames]{xcolor}

\definecolor{darkblue}{rgb}{0.0, 0.0, 0.55}
\definecolor{cyan(process)}{rgb}{0.0, 0.72, 0.92}

\newcommand{\todo}[1]{{\color{red}[TODO: "#1'']}}
\newcommand{\inblue}[1]{{\color{blue}#1}}
\newcommand{\cyan}[1]{{\color{cyan(process)}#1}}
\newcommand{\inred}[1]{{\color{red}#1}}
\newcommand{\ingreen}[1]{{\color{green}#1}}


%%%%%%%%%%%%%%%%%%% subsubsubsection (see: https://tex.stackexchange.com/questions/60209/how-to-add-an-extra-level-of-sections-with-headings-below-subsubsection )
% \setcounter{secnumdepth}{5}
% \setcounter{tocdepth}{5}

% \makeatletter
% \newcommand\subsubsubsection{\@startsection{paragraph}{4}{\z@}{-2.5ex\@plus -1ex \@minus -.25ex}{1.25ex \@plus .25ex}{\normalfont\normalsize\bfseries}}
% \newcommand\subsubsubsubsection{\@startsection{subparagraph}{5}{\z@}{-2.5ex\@plus -1ex \@minus -.25ex}{1.25ex \@plus .25ex}{\normalfont\normalsize\bfseries}}
% \makeatother
%%%%%%%%%%%%%%%%%%%
\makeatletter
\@ifclasswith{iucr}{preprint}{
\newcommand{\whencolumns}[2]{#1}
}{
\newcommand{\whencolumns}[2]{#2}
}
\makeatother

     %-------------------------------------------------------------------------
     % Infobrmation about journal to which submitted
     %-------------------------------------------------------------------------
     \journalcode{X}              % Indicate the journal to which submitted
                                  %   A - Acta Crystallographica Section A
                                  %   B - Acta Crystallographica Section B
                                  %   C - Acta Crystallographica Section C
                                  %   D - Acta Crystallographica Section D
                                  %   E - Acta Crystallographica Section E
                                  %   F - Acta Crystallographica Section F
                                  %   J - Journal of Applied Crystallography
                                  %   M - IUCrJ
                                  %   S - Journal of Synchrotron Radiation

\begin{document}  % DO NOT DELETE THIS LINE

\title{Perfect-crystal diffraction \inblue{formulation} from the Takagi-Taupin equations, and numerical implementation in the \texttt{crystalpy} library.}


\cauthor[a]{Jean-Pierre}{Guigay}{guigay@esrf.eu}{address if different from \aff}
\author[a]{Manuel}{Sanchez del Rio}


\aff[a]{European Synchrotron Radiation Facility, 71 Avenue des Martyrs F-38000 Grenoble \country{France}}

\maketitle   % DO NOT DELETE THIS LINE

\begin{synopsis}
The Takagi-Taupin equations are solved in their simplest form (zero deformation) and equations of the diffracted and transmitted amplitudes are obtained. Then, the case of a multilayered crystal is discussed using a matrix model. The theory presented is coded in the open-source software package {\tt crystalpy}.
\end{synopsis}

\begin{abstract}

The Takagi-Taupin equations are solved in their simplest form (zero deformation) to obtain the Bragg-diffracted and transmitted complex amplitudes. The case of plane-parallel crystal plates is discussed using a matrix model. The equations are implemented in an open-source python library \texttt{crystalpy} adapted for numerical applications such as crystal reflectivity calculations and ray tracing.

\end{abstract}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
\label{sec:Intro}

Almost every synchrotron radiation beamline operating at hard X-rays makes use of perfect crystals.  
Most beamlines use crystal monochromators, typically in the DCM (double crystal monochromator) mode, but polychromators or single-crystal Laue monochromators can be also found. In addition, crystal analyzers are used in most spectroscopy beamlines. 
Beamline simulation tools used for the design, optimization, and commissioning of synchrotron instrumentation, implement in software the equations to calculate the reflectivity of perfect crystals. The theory of diffraction (see \cite{authierbook} for a complete reference) puts the basis of all numeric implementations. 

There are many simulation tools implementing the equations of the dynamical theory in different forms. This variate scenario is even more complex if we consider that the calculation of the crystal structure factor, which is an essential ingredient to calculating diffracted amplitudes and intensities, is obtained from tabulated scattering functions of multiple origins. A wide collection of software methods and tools can be found even in a single application, such as the OASYS suite \cite{codeOASYS}, which provides multiple solutions for calculating diffraction profiles of crystals [e.g. INPRO\footnote{\texttt{https://github.com/oasys-kit/xoppy\_externa\_codes/tree/master/src/INPRO}}, CRYSTAL \cite{codeCRYSTAL}, X-RAY Server \cite{codeXRAYserver}], as well as beamline simulation tools [based on the ray tracing code SHADOW \cite{codeSHADOW}] and physical wave-optics simulations with SRW \cite{codeSRW, codeSRWcrystals}.
This scenario has inherited decades of advancements and has witnessed the evolution of several generations of synchrotron radiation sources.
Our research aims to tackle this challenge by consolidating the resources for crystal diffraction calculations. We have two primary objectives: deducing the equations governing crystal reflectivity from first principles and integrating them into a thoroughly documented open-source software library.

In section~\ref{sec:TT} we derive the Takagi-Taupin (TT) equations \cite{Takagi1962, Taupin, Taupin1967} equations.
In section~\ref{sec:TTsolutions} we solve the TT equations for a plane undeformed-crystal.
Given known amplitudes at the entrance surface, the amplitudes along the incident and diffracted directions at the back surface are calculated via the transfer matrix (section~\ref{sec:transferMatrix}). For the Laue case, the transfer matrix can be used to compute the diffracted and forward-diffracted (or transmitted) amplitudes for a crystal set in Laue or transmission (section~\ref{sec:TTsolutionsLaue}). For the Bragg case (section~\ref{sec:TTsolutionsBragg}) the transfer matrix is used to obtain the scattering matrix, which gives the diffracted and forward-diffracted (or transmitted) amplitudes. 
Section~\ref{sec:crystalpy} is dedicated to the software implementation of the library \texttt{crystalpy}. A final summary and conclusions are in section~\ref{sec:summary}.
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Takagi-Taupin equations for a plane monochromatic incident wave}
\label{sec:TT}

The scalar time-independent x-ray wave equation in a perfect crystal is the Helmholtz equation

\begin{equation}
\label{eq:helmholz}
    \Delta \Psi + k^2 (1+\chi(\textbf{r})) \Psi(\textbf{r}) = 0,
\end{equation}
with $\Psi(\textbf{r})$ is the wave-function, $k=2\pi/\lambda$, with $\lambda$ the wavelength. $\chi$ is the electric susceptibility (refraction index $n=(1+\chi)^{1/2}$)
that can be expanded in a Fourier series,
\begin{equation}
\label{eq:chi}
    \chi(\textbf{r}) = \sum_{\textbf{h}} \chi_h \exp(i \textbf{h} . \textbf{r}),
\end{equation}
where 
the sum goes over all reciprocal lattice vectors $\textbf{h}$ with (hkl) Miller indices. 
The spacing of the (hkl) reflection is $d_\text{hkl}=2 \pi/|\textbf{h}|$.

Let us consider an incident plane wave $\exp(i\textbf{k}_0 . \textbf{r})$ in vacuum. Its wavevector $\textbf{k}_0$, with modulus $k=|\textbf{k}_0|$ is \inblue{close,
% ($|\textbf{k}_h| \approx k$)
but not exactly on the Bragg condition.} 
% ($|\textbf{k}_h|= k$).
In the ``two-\inblue{beams} case" of Bragg diffraction, considered in this paper, one can \textit{define} a single vector $\textbf{k}_h \equiv \textbf{k}_0+\textbf{h}$. This vector will be used to define a dedicated reference frame. In general, the direction of $\textbf{k}_h$ does not correspond to the diffracted wavevector, and its modulus $k_h=|\textbf{k}_h|$ is different from $k$. The direction of the diffracted wave is discussed in section \ref{sec:directions}. 
The deviation of $\textbf{k}_0$ from the exact Bragg position is expresses by the $\alpha$ parameter ($\alpha \ll 1$)
 \footnote{In the``rotating crystal mode" $\alpha=4 \sin \theta_B (\sin \theta - \sin \theta_B) \approx 2 (\theta-\theta_B) \sin (2\theta_B)$, with $\theta$ the glancing angle on the reflective planes. Note that the approximated value of $\alpha$ is not valid far from the Bragg position or when $\cos\theta_B \rightarrow 0$ (normal incidence), therefore  equation~(\ref{eq:alpha}) is used in the {\tt crystalpy} software. }\footnote{
 The choice of the sign of $\alpha$ is made in such a way that $\alpha$ increases when $\theta$ increases. Our $\alpha$ has the opposite sign than the $\alpha$ defined in (equation [3.114b]) of \cite{ZachariasenBook}. 
 } defined as
\begin{equation}
\label{eq:alpha}
\alpha = \frac{k^2-k_h^2}{k^2} = \frac{k^2-(\textbf k_0 + \textbf h)^2}{k^2} = - \frac{\textbf h^2 + 2 \textbf k_0 . \textbf h}{k^2}.
\end{equation}

The wave-field $\Psi(\textbf{r})$ in the crystal is the sum of ``two modulated plane waves": 
\begin{equation}
\label{eq:wavefield}
    \Psi(\textbf r) = D_0(\textbf r) e^{i \textbf k_0 . \textbf r} + D_h(\textbf r) e^{i \textbf k_h . \textbf r}.
\end{equation}
It is furthermore considered that the amplitudes $D_{0,h}(\textbf{r})$ are ``slowly varying functions", thus neglect the 2$^{\text{nd}}$ order derivatives of $D_{0,h}$ in the calculation of $\Delta \Psi(\textbf{r})$
\begin{equation}
\Delta[D_{0,h}(\textbf{r}) \exp(i\textbf{k}_{0,h} . \textbf{r})] \approx 
 [2 i \textbf{k}_{0,h} . \nabla D_{0,h} - k^2_{0,h} D_{0,h}] \exp(i\textbf{k}_{0,h} . \textbf{r}), \nonumber
\end{equation}

In the calculation of $\chi(\textbf{r}) \Psi(\textbf{r})$, using the above formulas, we separate the terms containing either $\exp(i \textbf{k}_0 . \textbf{r})$ or $\exp(i \textbf{k}_h . \textbf{r})$, and do not consider the other terms\footnote{
We discarded the terms $\chi_h D_h \exp(i (\textbf{k}_0+2\textbf{h}) . \textbf{r}) + \chi_{-h} D_0 \exp(i (\textbf{k}_0 - 2 \textbf{h}) .\textbf{r})$,
in such a way that the two-beam approximation is maintained.}
\begin{equation}
\label{eq:approxchiPsi}
\chi\Psi =
\chi_0 D_0 \exp(i \textbf{k}_0 . \textbf{r}) +
\chi_h D_0 \exp(i \textbf{k}_h . \textbf{r}) +
\chi_0 D_h \exp(i \textbf{k}_h . \textbf{r}) +
\chi_{-h} D_h \exp(i \textbf{k}_0 . \textbf{r}). \nonumber
\end{equation}

We obtain in this way the TT equations 
% \begin{subequations}
% \label{eq:TTvector}
% \begin{align}
% 2 i \textbf{k}_0 . \nabla D_0 + \chi_0 k^2 D_0 + \chi_{-h} k^2 D_h =& 0; \\
% 2 i \textbf{k}_h . \nabla D_h + (k^2 - k_h^2 + \chi_0 k^2) D_h + \chi_{h} k^2 D_0 =& 0.
% \end{align}
% \end{subequations}
\begin{subequations}
\label{eq:TTvectorAlpha}
\begin{align}
2 i \textbf{k}_0 . \nabla D_0 + \chi_0 k^2 D_0 + \chi_{-h} k^2 D_h =& 0; \\
2 i \textbf{k}_h . \nabla D_h + (\alpha + \chi_0) k^2 D_h + \chi_{h} k^2 D_0 =& 0.
\end{align}
\end{subequations}

In the diffraction plane (the plane containing $\textbf{k}_0$ and $\textbf{h}$) 
we can use the oblique coordinates $(s_0,s_h)$ along the directions of $\textbf k_0$ and $\textbf k_h$ (unit vectors $\hat{ \textbf{s}}_{0}$ and $\hat{ \textbf{s}}_{h}$, respectively). A generic spatial position  $\textbf r=(s_0,s_h,s_t)$ includes a third coordinate $s_t$ along an axis $\hat{\textbf{s}}_t$ non coplanar with $\textbf{k}_0$ and $\textbf{k}_h$.
The equation of the crystal surface is $\gamma_0 s_0 + \gamma_h s_h + \gamma_t s_t=0$, with $\gamma_{0,h,t}=\cos(\textbf{n} , \hat{\textbf{s}}_{0,h,t}) \equiv \cos(\theta_{0,h,t})$ the director cosines.
For any point $\textbf r=(s_0,s_h,s_t)$ inside the crystal we introduce the path length $s$ of the incident ray going in this point: this ray enters the crystal at the point of coordinates $(s'_0,s_h,s_t)$ such that $\gamma_0 s'_0+\gamma_h s_h + \gamma_t s_t=0$, so that 
\begin{equation}
\label{eq:s}
s = s_0 - s'_0 = s_0 + s_h \frac{\gamma_h}{\gamma_0} + s_t \frac{\gamma_t}{\gamma_0}.
\end{equation}

The simple relation $d s_0 = \nabla s_0 . [ d s_0 . \hat{\textbf{s}}_0 + d s_h \hat{\textbf{s}}_h + d s_t \hat{\textbf{s}}_t ]$ implies $\nabla s_0 . \hat{\textbf{s}}_0=1$ and $\nabla s_0 . \hat{\textbf{s}}_{h,t}=0$. Similarly, $\nabla s_h . \hat{\textbf{s}}_h=1$ and $\nabla s_h . \hat{\textbf{s}}_{0,t}=0$. Therefore, 
\begin{subequations}
\label{eq:equalities}
\begin{align}
\hat s_0 . \nabla D=
\hat s_0 . \left[ 
\frac{\partial D}{\partial s_0} \nabla s_0 + 
\frac{\partial D}{\partial s_h} \nabla s_h +
\frac{\partial D}{\partial s_t} \nabla s_t
\right] 
=& \frac{\partial D}{\partial s_0}
; \\
\hat s_h \nabla D =& 
\frac{\partial D}{\partial s_h}.
\end{align}
\end{subequations}

Using the approximation
\begin{equation}
\label{eq:approxKH}
\textbf k_h . \nabla D_h = |\textbf k_h| \frac{\partial D_h}{\partial s_h} \approx k \frac{\partial D_h}{ \partial s_h},
\end{equation}
we obtain from equations~(\ref{eq:TTvectorAlpha})
\begin{subequations}
\label{eq:TT}
\begin{align}
\frac{\partial D_0}{\partial s_0} =& \frac{ik}{2} \left[ \chi_0 D_0(s_0,s_h,s_t)+ \chi_{-h} D_h(s_0,s_h,s_t) \right]; \\
\frac{\partial D_h}{\partial s_h} =& \frac{ik}{2} \left[ (\chi_0 + \alpha) D_h(s_0,s_h,s_t)+ \chi_{h} D_0(s_0,s_h,s_t) \right],
\end{align}
\end{subequations}
or in a more compact form
\begin{subequations}
\label{eq:TTcompact}
\begin{align}
\frac{\partial D_0}{\partial s_0} =& i u_0 D_0(s_0,s_h,s_t) + i u_{-h} D_h(s_0,s_h,s_t); \\
\frac{\partial D_h}{\partial s_h} =& i (u_0 + \alpha') D_h(s_0,s_h,s_t) + i u_{h} D_0(s_0,s_h,s_t),
\end{align}
\end{subequations}
where the notation 
\begin{subequations}
\label{eq:uandalphaprime}
\begin{align}
    u_{0,h,-h}&=\frac{k}{2} \chi_{0,h,-h},  \\
     \alpha'  &= \frac{k}{2}  \alpha.
\end{align}
\end{subequations}
is used.
Note that $\alpha'=2 k \sin\theta_B(\sin\theta-\sin\theta_B)=|\textbf{h}|(\sin\theta-\sin\theta_B)$.
An equivalent form of the TT equations~(\ref{eq:TT}) is obtained in appendix~\ref{appendix:rotating}, using oblique axes along the fixed directions of the geometrical Bragg reflection and applying a crystal rotation.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Solutions of TT equations}
\label{sec:TTsolutions}

It is interesting to consider first the effects of refraction and absorption without Bragg diffraction. 
Setting $u_{-h}=0$ in equation~(\ref{eq:TTcompact}a), we obtain the following equation for the refracted amplitude 
\begin{equation}\label{eq:refraction}
\frac{\partial D_0^{\text{ref}}}{\partial s_0} = i u_0 D_0^{\text{ref}}.
\end{equation}
The solution of equation~(\ref{eq:refraction}) that satisfies the boundary conditions $D_0^{\text{ref}}=1$ for  $\gamma_0 s_0 + \gamma_h s_h + \gamma_t s_t=0$ (equation of the crystal surface) is $D_0^{\text{ref}}= \exp[i u_0 (s_0 + s_h \gamma_h/\gamma_0)]$.

We will now consider the solutions of the TT equations~(\ref{eq:TTcompact}) depending on the single variable $s=s_0+s_h \gamma_h/\gamma_0$, which means 
$\partial D_{0} / \partial  s_{0}=D'_{0}(s)$ and $\partial D_{h} / \partial s_{h}=D'_{h}(s)\gamma_h/\gamma_0$.
Defining 
\begin{equation}\label{eq:b}
b = \frac{\gamma_0}{\gamma_h},    
\end{equation}
the equations~(\ref{eq:TTcompact}) become
\begin{subequations}
\label{eq:TTlaue}
\begin{align}
D'_0(s) =& i u_0 D_0(s) + i u_{-h} D_h(s); \\
D'_h(s) =& i b (u_0 + \alpha') D_h(s) + i b u_{h} D_0(s).
\end{align}
\end{subequations}

It is convenient to introduce the functions $B_{0,h}(s)$ by setting
\begin{equation}
\label{eq:Bdefinition}
D_{0,h}(s) = \exp \left[ i s \frac{u_0 + b (u_0+\alpha')}{2} \right] B_{0,h}(s) = \exp[i s (u_0+\omega)] B_{0,h}(s),  
\end{equation}
with
\begin{equation}\label{eq:omega}
    \omega=\frac{ b \alpha' + (b-1) u_0}{2}.
\end{equation} 
\inblue{
It happens that $\operatorname{Re}(\omega)=0$ for the ``corrected Bragg angle" $\theta_c$. Therefore $b\operatorname{Re}(\alpha')=(1-b)\operatorname{Re}(u_0)$ or 
\begin{equation}\label{eq:correctedBraggAngleExact}
   \sin\theta_c = \sin\theta_B + \frac{1-b}{b|\textbf{h}|} \operatorname{Re}(u_0),  
\end{equation}
which under the usual conditions ($\sin\theta_c-\sin\theta_B \approx  (\theta_c-\theta_B) \cos\theta_B$) reduces to
\begin{equation}\label{eq:correctedBraggAngle}
   \theta_c \approx \theta_B + \frac{1-b}{2 b \sin2\theta_B} \operatorname{Re}(\chi_0).  
\end{equation}
}

% \todo{MOVE SOMEWHERE ELSE

% We define the Bragg angle corrected for refraction $\theta_c$. In the general case, for $\theta=\theta_c$ the real part of $\omega$ is zero. In the non-absorbing case,  for $\theta=\theta_c$, $\omega$ is zero.
% We obtain from equation~(\ref{eq:omega})
% \begin{equation}\label{eq:correctedBraggAngleExact}
%    \sin\theta_c = \sin\theta_B + \frac{1-b}{4 b \sin\theta_B} \operatorname{Re}\chi_0,   
% \end{equation}
% which under the usual conditions ($\sin\theta_c-\sin\theta_B \approx  (\theta_c-\theta_B) \cos\theta_B$) reduces to
% \begin{equation}\label{eq:correctedBraggAngle}
%    \theta_c \approx \theta_B + \frac{1-b}{2 b \sin2\theta_B} \operatorname{Re}\chi_0.  
% \end{equation}
% }

The differential equations for $B_{0,h}(s)$ are 
\begin{subequations}
\label{eq:TTinB}
\begin{align}
B'_0(s) =& -i \omega B_0(s) + i u_{-h} B_h(s); \\
B'_h(s) =& i \omega B_h(s) + i b u_{h} B_0(s).
\end{align}
\end{subequations}
which have special solutions of the form\footnote{these solutions are the Ewald wavefields discussed in detail in \cite{authierbook} using the concept of dispersion surface.} $(B_0(s)=\exp(i a s)$, $B_h(s)=\xi \exp(i a s))$, with $a = \xi u_{-h} -\omega$, and $a \xi=\xi \omega+b u_h$; therefore
\begin{equation}\label{eq:a}
    a^2=b u_h u_{-h}+\omega^2,
\end{equation}
and $\xi_{1,2}$ are related to the two solutions $\pm a$ of equation~(\ref{eq:a}) as 
\begin{equation}\label{eq:xis}
\xi_{1,2}= \frac{\pm a + \omega }{u_{-h}}=\frac{b u_h}{\pm a-\omega}.    
\end{equation}
The general solution of equation~(\ref{eq:TTinB}) is
\begin{subequations}
\label{eq:BSolutions}
\begin{align}
B_0(s) = &c_1 \exp(i a s) + c_2 \exp(-i a s), \\
B_h(s) = &c_1 \xi_1 \exp(i a s) + c_2 \xi_2 \exp(-i a s),
\end{align}
\end{subequations}
from which the $c_{1,2}$ coefficients can be expressed in terms if $B_{0,h}(0)$ as
% It is convenient to express equations~(\ref{eq:BSolutions}) in terms of $B_0(0)=c_1+c_2$ and $B_h(0)=\xi_1 c_2+\xi_2 c_2$, from which 
\begin{equation}
\label{eq:cs}
c_1=\frac{B_h(0)-\xi_2 B_0(0)}{\xi_1-\xi_2};
c_2=\frac{B_h(0)-\xi_1 B_0(0)}{\xi_2-\xi_1}. \nonumber
\end{equation}
Consequently, 
\begin{subequations}
\label{eq:preBSolutions}
\begin{align}
B_0(s) = &B_0(0) \frac{\xi_1 e^{-ias} - \xi_2 e^{ias}}{\xi_1-\xi_2} + 
    B_h(0) \frac{e^{ias} - e^{-ias}}{\xi_1-\xi_2} \\
B_h(s) = &B_0(0) \xi_1\xi_2 \frac{e^{-ias} - e^{ias}}{\xi_1-\xi_2} + 
    B_h(0) \frac{\xi_1 e^{ias} - \xi_2 e^{-ias}}{\xi_1-\xi_2}.
\end{align}
\end{subequations}
Noting that (from equation~(\ref{eq:xis}))
\begin{equation}
\label{eq:xiidentities}
\xi_1-\xi_2=\frac{2a}{u_{-h}};~~~
\frac{\xi_{1,2}}{\xi_1-\xi_2}=\frac{\omega \pm a}{2a};~~~
\frac{\xi_1 \xi_2}{\xi_1-\xi_2}=-\frac{b u_h}{2a}; \nonumber
\end{equation}
we obtain
\begin{subequations}
\label{eq:BSolutions}
\begin{align}
B_0(s) = &B_0(0) \frac{(a-\omega) e^{ias} + (\omega+a) e^{-ias}}{2a} + 
    B_h(0) u_{-h} \frac{e^{ias} - e^{-ias}}{2a} \\
B_h(s) = &B_0(0) b u_h \frac{e^{ias} - e^{-ias}}{2a} + 
    B_h(0) \frac{(\omega+a) e^{ias} - (\omega-a) e^{-ias}}{2a},
\end{align}
\end{subequations}
or, in a more compact form \inblue{in terms of $D_{0,h}(s)$ [equation~(\ref{eq:Bdefinition})],}
\begin{subequations}
\label{eq:DSolutionsCompact}
\begin{align}
e^{-is(u_0+\omega)} D_0(s) = & [\cos(as) - i\frac{\omega}{a}\sin(as)] D_0(0) +     i \frac{u_{-h}}{a}\sin(as) D_h(0), \\
e^{-is(u_0+\omega)} D_h(s) = & i b \frac{u_h}{a} \sin(as) D_0(0) + 
    [\cos(as) + i \frac{\omega}{a} \sin(as)] D_h(0).
\end{align}
\end{subequations}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The Transfer matrix of a parallel crystal slab}
\label{sec:transferMatrix}

The front and back surfaces of a crystal parallel slab correspond to $s$=0 and $s=t_c/\gamma_0=T$, respectively, with $t_c$ the usual thickness of the crystal. Some boundary conditions are known, usually the incident beam.   
We can express the fields at the back surface $(D_0(T),D_h(T))$ in terms of those at the front surface $(D_0(0),D_h(0))$ in a matrix form
\begin{equation}\label{eq:Mtransfer}
    \begin{pmatrix}
    D_0(T)\\
    D_h(T)
    \end{pmatrix}
    =
    M
        \begin{pmatrix}
    D_0(0) \\
    D_h(0)
    \end{pmatrix}
    =
    \begin{pmatrix}
    m_{11} & m_{12}\\
    m_{21} & m_{22}
    \end{pmatrix}
    \begin{pmatrix}
    D_0(0) \\
    D_h(0)
    \end{pmatrix}.
\end{equation}

According to equation~(\ref{eq:DSolutionsCompact}), the elements of the transfer matrix are
\begin{subequations}\label{eq:MtransferElements}
\begin{align}
m_{11} &= \left[ \cos(aT)-i\frac{\omega}{a}\sin(aT) \right] e^{i T (u_0+\omega)};\\
m_{12} &= i \frac{u_{-h}}{a}\sin(aT) e^{i T (u_0+\omega)};\\
m_{21} &= i b \frac{u_h }{a} \sin(aT) e^{i T (u_0+\omega)};\\
m_{22} &= \left[ \cos(aT)+i \frac{\omega}{a}\sin(aT) \right] e^{i T (u_0+\omega)}.
\end{align}
\end{subequations}

The determinant of the matrix $M$ is $\text{det}(M)=\exp[2 i T (u_0+\omega)]$. Its modulus is equal to one for a non-absorbing crystal (in this case $u_0$ and $\omega$ are real).
% if we exclude the exponential term related to normal absorption and refraction. 
This is in agreement with the expected energy conservation. It can be verified that $M(T_1+T_2)=M(T_1) M(T_2)$ and $M(-T)=[M(T)]^{-1}$. Last, but not least, equations~(\ref{eq:DSolutionsCompact}) are valid for both Bragg and Laue cases (using the adequate values of $b$, $a$ and $\omega$).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The transfer matrix for the case of a ``thick crystal"}
\label{sec:Mthick}

Equations~(\ref{eq:DSolutionsCompact}) and (\ref{eq:MtransferElements}) are expressed in terms of $a$ but they depend only on $a^2$.
It is possible to write them as 
\begin{equation}\label{eq:Mfactorized}
    M =
    \frac{e^{i(u_0+\omega+a)T}}{2a}
    \begin{pmatrix}
    a-\omega & u_{-h}\\
    b u_h & a + \omega
    \end{pmatrix}
    + 
    \frac{e^{i(u_0+\omega-a)T}}{2a}
    \begin{pmatrix}
    a+\omega & -u_{-h}\\
    -b u_h & a - \omega
    \end{pmatrix}, 
\end{equation}
where the two terms are interchangeable when $a$ is changed in $-a$. They correspond to the two roots of $a^2$. The real part of the argument of the exponential factors is equal to $-T \operatorname{Im} u_0 [(b+1)/2  \pm \operatorname{Im} a]$.
\inblue{
The ``normal" absorption is represented as $\exp[-T \operatorname{Im} u_0 (b+1)/2 ]$.
When $\operatorname{Im}a<0$,
the absorption will be less than the ``normal" absorption for the first matrix, and more than ``normal" absorption for the second one. Similarly, for  $\operatorname{Im}a>0$ the matrices present opposite behavior.  If $T |\operatorname{Im}a|$ is large (for example $T |\operatorname{Im}a|  \gtrsim 5$), we can neglect one of the two terms in equation~(\ref{eq:Mfactorized}):
}
\begin{equation}\label{eq:Mthickapprox}
    M^{\text{thick}} \approx \begin{cases} 
    \frac{e^{i(u_0+\omega+a)T}}{2a}
    \begin{pmatrix}
    a-\omega & u_{-h}\\
    b u_h & a + \omega
    \end{pmatrix}, & \text{\inblue{where} $\operatorname{Im}a<0$}.\\
    
    \frac{e^{i(u_0+\omega-a)T}}{2a}
    \begin{pmatrix}
    a+\omega & -u_{-h}\\
    -b u_h & a - \omega
    \end{pmatrix}, & \text{\inblue{where} $\operatorname{Im}a>0$}.
    \end{cases}
\end{equation} 

\inred{An x-ray beam may go through such a ``thick crystal" in the condition of Bragg diffraction, where it would be normally absorbed.} This is a manifestation of the Bormann effect (anomalous absorption).



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Reflection and transmission amplitudes in transmission geometry (Laue case)}
\label{sec:TTsolutionsLaue}

In this case $b>0$. The boundary conditions are $(D_0(0),D_h(0))=(1,0)$. 
The reflection and transmission amplitudes,
$r_L=D_h(T)$ and $t_L=D_0(T)$, respectively, are directly obtained from two terms of the matrix equation~(\ref{eq:Mtransfer}): 
\begin{subequations}
\label{eq:lauerandt}
\begin{empheq}[box=\fbox]{align}
r_L = m_{21} = & i b u_h \frac{\sin(a T)}{a} e^{iT (u_0+\omega)}  \\
t_L = m_{11} = & \left(\cos(a T) - i \omega\frac{\sin(a T)}{a}  \right) e^{i T (u_0+\omega)}.
\end{empheq}
\end{subequations}

The reflecting power, or diffraction profile, often referred as rocking curve, is obtained from equations~(\ref{eq:lauerandt}) as $\mathcal{R}(\theta)=|r(\theta)|^2 P$, with   the power factor $P=1/|b|$ (see \cite{ZachariasenBook} pag. 122). The forward diffracted profile (or transmitted) is $\mathcal{T}=|t|^2$. There are called hereafter reflectance ($\mathcal{R}$) and transmittance ($\mathcal{T}$). An example is in Fig.~\ref{fig:laueProfiles}. 


\begin{figure}\label{fig:laueProfiles}
    \centering
    \includegraphics[width=0.49\textwidth]{figures/Laue_1.eps}
    \includegraphics[width=0.49\textwidth]{figures/Laue_2.eps}
    \caption{Calculated reflectance and transmittance for a \SI{10}{\micro\meter} thick Laue Si 111 crystal at 8 keV, \inblue{with 65 degrees of asymmetric angle.}}
\end{figure}

It is also interesting to consider the case of incidence along the direction of $\textbf{k}_h$ (diffraction vector $-\textbf{h}$), for which ($D_0(0), D_h(0)=(0,1)$. It is directly seen from equation~(\ref{eq:Mtransfer}) that the transmission and reflection amplitudes are $\bar{t}_L=m_{22}$ and $\bar{r}_L=m_{12}$ (note that in this case the reflection power factor will be $P=|b|$). These results can be written as

\begin{equation}\label{eq:MtransferLaue}
    \begin{pmatrix}
    t_L & \bar{r}_L\\
    r_L & \bar{t_L}
    \end{pmatrix}
    =
    \begin{pmatrix}
    m_{11} & m_{12}\\
    m_{21} & m_{22}
    \end{pmatrix}
    = M.
\end{equation}
This means that for the Laue case the matrix $M$ can be considered not only as ``transfer-matrix" of the crystal slab, but also as the ``scattering-matrix" ($S$-matrix) which relates the vacuum waves leaving the crystal to the vacuum waves entering it, in analogy with the $S$-matrix used in general scattering theory.  

A careful look at the real and imaginary parts of the complex parameters $u_{0,h,-h}$ and $a$ leads to common expressions for absorption and Pendell\"osung. 
The exponential factor in equations~(\ref{eq:lauerandt}) gives a pure absorption term, which is (using $u_0 +\omega=[(b+1)u_0+b\alpha']/2$ from equation~({\ref{eq:omega}}), 
and noting that $\alpha'$ is real):  
\begin{equation}
   \exp[\operatorname{Re}(-iT(u_0+\omega))] = 
    \exp[-T \frac{b+1}{2}\operatorname{Im}(u_0)] =  
    \exp[-T \frac{\pi}{\lambda}\frac{b+1}{2} \operatorname{Im} \chi_0].
\end{equation}
The Pendell\"osung effect is due to the oscillations of $|\sin(aT)|^2$. Remembering the identity $|\sin(x+iy)|^2=\sin^2x + \sinh^2 y$, we get a Pendell\"osung distance (depending on $\theta$) along $s_0$ equal to  
$\pi / |\operatorname{Re} a|=\lambda / \operatorname{Re}\sqrt{b\chi_h\chi_{-h} + w^2}$.
At $\theta=\theta_c$, $b \chi_h \chi_{-h}+w^2=b \chi_h \chi_{-h} - [(\operatorname{Im}\chi_0(b-1)/2]^2$. In symmetric Laue case ($b$=1) we obtain the well-known formula of the Pendell\"osung distance along the direction normal to the crystal surface
\begin{equation}\label{eq:Pendellosung}
    \Lambda =\frac{\lambda \cos\theta_B}{\operatorname{Re}\sqrt{\chi_h\chi_{-h}}} .
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Reflection and transmission amplitudes in reflection geometry (Bragg case). The S-matrix}
\label{sec:TTsolutionsBragg}

In this case $b<0$. $T$ is, again, the path length in the crystal of the incident beam along $\textbf{k}_0$.
We set $D_0(0)=1$ and $D_h(T)=0$ (which means no beam entering the crystal slab on the back surface). The reflection and transmission amplitudes are
$r_B=D_h(0)$ and $t_B=D_0(T)$, respectively. From equation~(\ref{eq:Mtransfer}) we obtain
\begin{equation}\label{eq:braggrandtvsm}
    r_B = -\frac{m_{21}}{m_{22}}; ~~~~ t_B = m_{11}-\frac{m_{12} m_{21}}{m_{22}}.
\end{equation}
Similarly, in the case of incidence on the crystal back side along the direction $\textbf{k}_h$ (diffraction vector $-\textbf{h}$), we set in equation~(\ref{eq:Mtransfer}) $D_h(T)=1$, $D_0(T)=\bar{r}_B$, $D_0(0)=0$ and $D_h(0)=\bar{t}_B$. We obtain from equation~(\ref{eq:Mtransfer})
\begin{equation}\label{eq:braggtbarandrbar}
    \bar{t}_B = \frac{1}{m_{22}} \text{ and } \bar{r}_B = \frac{m_{12}}{m_{22}}.
\end{equation}

Consequently, the $S$-matrix for the Bragg case is represented as 
\begin{equation}\label{eq:scatteringMatrixDefinition}
    \begin{pmatrix}
    D_0(T)\\
    D_h(0)
    \end{pmatrix}
    =
    S
        \begin{pmatrix}
    D_0(0) \\
    D_h(T)
    \end{pmatrix},
\end{equation}
with
\begin{equation}\label{eq:scatteringMatrix}
    S = 
    \begin{pmatrix}
    s_{11} & s_{12}\\
    s_{21} & s_{22}
    \end{pmatrix}
    =
    \begin{pmatrix}
    m_{11}-\frac{m_{12} m_{21}}{m_{22}} & 
    \frac{m_{12}}{m_{22}}\\
    -\frac{m_{21}}{m_{22}} & 
    \frac{1}{m_{22}}
    \end{pmatrix}
    =
    \begin{pmatrix}
    t_B& 
    \bar{r}_B\\
    r_B& 
    \bar{t}_B
    \end{pmatrix}.
\end{equation}
Particularly, using equations~(\ref{eq:MtransferElements}),
\begin{subequations}
\label{eq:braggrandt}
\begin{empheq}[box=\fbox]{align}
r_B = s_{21}=
\frac{-i b u_h \sin(a T)}{a \cos(a T) + i \omega \sin(a T)}\\
t_B = s_{11}=
\frac{a~\exp(i T(u_0+ \omega))}{a \cos(a T) + i \omega \sin(a T)} ,
\end{empheq}
\end{subequations}

The diffraction profile (reflectance) is   $\mathcal{R}=|r|^2 P$, with $P=|b|^{-1}$ and the transmittance is $\mathcal{T}=|t|^2$. An example is in Fig.~\ref{fig:braggProfiles}. 

\begin{figure}\label{fig:braggProfiles}
    \centering
    \includegraphics[width=0.49\textwidth]{figures/Bragg_1.eps}
    \includegraphics[width=0.49\textwidth]{figures/Bragg_2.eps}
    \caption{Calculated reflectance and transmittance of a Bragg Si 111 crystal with \SI{10}{\micro\meter} thickness at 8 keV. }
\end{figure}

The field inside the crystal, i.e. $D_0(s)$ and $D_h(s)$, can be calculated using equations (\ref{eq:BSolutions}), with $D_0(0)=1$ and $D_h(0)=r_B$ from equation (\ref{eq:braggrandt}a) we obtain
\begin{subequations}\label{eq:bragginside}
\begin{align}
D_h(s)&=\frac{i b u_h \sin(as - aT)}{a \cos(aT) + i \omega \sin(aT)} e^{is(u_0+\omega)} 
= r_B \frac{\sin(as - aT)}{\sin(aT)} e^{is(u_0+\omega)}\\
D_0(s)&= \frac{a \cos(as-aT) - i \omega \sin(as-aT)}{a \cos(aT) + i \omega \sin(aT)} e^{is(u_0+\omega)}.
\end{align}
\end{subequations}

An example of simulation of the field inside the crystal using equations~(\ref{eq:bragginside}) is in Fig.~\ref{fig:braggMap}. For the Laue case, also shown in this figure, we observe that the field at coordinate $s$ is simply calculated by the equations~(\ref{eq:lauerandt}) replacing $T$ by $s$.

\begin{figure}\label{fig:braggMap}
    \centering
    \includegraphics[width=0.49\textwidth]{figures/Bragg_DH.png}
    \includegraphics[width=0.49\textwidth]{figures/Bragg_D0.png}
    \includegraphics[width=0.49\textwidth]{figures/Laue_DH.png}
    \includegraphics[width=0.49\textwidth]{figures/Laue_D0.png}
    \caption{Examples of electric field intensity inside the crystal as a function of the 
    deviation angle $\theta-\theta_B$ and thickness ratio $-s/T$ for a symmetric Si 111 at 8 keV with thickness $t=$\SI{50}{\micro\meter} in Bragg or Laue geometry. 
    a) Bragg $|D_h|^2$, b) Bragg $|D_0|^2$,
    c) Laue $|D_h|^2$, d) Laue $|D_0|^2$.
    \todo{Change the titles for consistency}
    }
\end{figure}

\textit{3.4.1  Reflection amplitude for a thick absorbing crystal in Bragg case}

In the case of thick (or semi-infinite) Bragg crystal, the reflection amplitude, given by equation (\ref{eq:braggrandtvsm}), takes the form [using $M$ from equation~(\ref{eq:Mthickapprox})]
\begin{equation}\label{eq:thickbraggr}
    r_B^{\text{thick}} = -\frac{m_{21}}{m_{22}} =
    \begin{cases} 
    -\frac{b u_h}{a+\omega}=\frac{\omega-a}{u_{-h}}, ~~~ \text{when} \operatorname{Im}(a)<0.
    \\
    \frac{b u_h}{a-\omega} = \frac{\omega+a}{u_{-h}}, ~~~ \text{when} \operatorname{Im}(a)>0.
    \end{cases}
\end{equation}
\inblue{
Both equations are the same, if we make the right choice of the sign in $a=\pm \sqrt{a^2}$. Physically, it means that $r_B^{\text{thick}} \rightarrow 0$ for large values of $|\theta-\theta_B|$, or, in other words, the tails of the diffraction profile must go to zero. Expressing the real and imaginary parts of $\omega$ and $a$ as a function of $(\sin\theta-\sin\theta_B)$ we can verify that the condition on $\operatorname{Im}(a)$ in equation~(\ref{eq:thickbraggr}) satisfy that the tails go to zero. Moreover, the choice of sign can be done by looking at the real parts of $a$ and $\omega$: it can be verified that the sign chosen when the condition $\operatorname{Im}(a)< 0$ is the same as the sign given by the condition $\text{sgn}(\operatorname{Re}\omega)= \text{sgn}(\operatorname{Re}a)$
[similarly $\operatorname{Im}(a) > 0$ gives the same sign as condition $\text{sgn}(\operatorname{Re}\omega)= -\text{sgn}(\operatorname{Re}a)$]. 
}
Equation~(\ref{eq:thickbraggr}) is a useful result, as most crystal monochromators used in synchrotron radiation are thick crystals in Bragg (reflection) mode. 

% \todo{REMOVE? Note that $a$, when obtained from $a^2$ has the indetermination in the sign of the square root. The physical parameter is $a^2$. It is useful to give the expression of $a$ from $a^2$ without the problem of the sign:
% \begin{equation}
% a = \frac{1}{\sqrt{2}} \left[ \frac{\operatorname{Im}(a^2)}{\sqrt{|a^2|-\operatorname{Re}(a^2)}} + i \sqrt{|a^2|-\operatorname{Re}(a^2)} \right]=
% \frac{1}{\sqrt{2}}\left[
% \text{sgn}[\operatorname{Im}(a^2)]\sqrt{
% |a^2| + \operatorname{Re}(a^2)+ i \sqrt{|a^2|-\operatorname{Re}(a^2)}
% }]
% \right].
% \end{equation}
% }

% \todo{NOT CORRECT?
% Another way to obtain this result is to consider the limit of the reflection amplitude in equation~(\ref{eq:braggrandt}a) when $aT \rightarrow \infty$. However, it does not have a well-defined limit, in common sense, because it involves periodic functions. We can define the limit as the zero-order term of the Fourier series expansion (or, equivalently, the average of this function over one period). Considering that the function $f(x)= i \sin(x) / (K \cos x + i L \sin x)$ has average (zeroth order of the Fourier series) $\overline{f(x)}=(L-K)^{-1}$ (see Appendix XX), we obtain, averaging equation~(\ref{eq:braggrandt}a) that $\overline{r_B}=-b u_h / (\omega -a)$, therefore identical to $r_B^{\text{thick}}$ in equation~(\ref{eq:thickbraggr}). 

% The reflecting power can be calculated in the usual way
% \begin{equation}\label{eq:DarwinGeneral}
%     \mathcal{R}_B = \frac{\overline{r_B} (\overline{r_B})^* }{|b|} 
%     = \frac{|b| u_h u_h^*}{|\omega-a|^2}, 
% \end{equation}
% which corresponds to the so-called Darwin solution. The other solution used in literature is the Ewald solution, that is: 
% \begin{equation}\label{eq:EwaldGeneral}
%     \mathcal{R}_B^{\text{Ewald}} = \frac{\overline{(r_B r_B^*)}} {|b|} 
%     = \frac{|b| u_h u_h^*}{(\omega-a)\omega},
% \end{equation}
% where we used the result in appendix X $\overline{(f(x) f^*(x))}=[(L-K)L]^{-1}$.
% }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\textit{3.4.2  Reflection amplitude for non-absorbing crystals in Bragg case}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this case $u_{-h}=u^*_h$; $\omega$ [see equation~(\ref{eq:omega})] and $a^2=\omega^2-|b| u_h u_{h}^*$ are real. We can distinguish two cases. 

If $a^2\inblue{\le}0$, then $a=i\sqrt{|b|u_u u_h^* - \omega^2}$ therefore
\begin{equation}\label{eq:totalreflection}
    r_B^{\text{thick, transparent}} =
    \frac{1}{u_{h}^*}\left( \omega+i\sqrt{|b|u_h u_h^*-\omega^2} \right), ~~~ \text{if~}|b|u_h u_h^* \inblue{\ge} \omega^2.
\end{equation}

If $a^2 > 0$,
\begin{equation}\label{eq:tails}
    r_B^{\text{thick, transparent}} =
    \frac{1}{u_{h}^*}\left( \omega-\text{sgn}(\omega)\sqrt{\omega^2-|b|u_h u_h^*} \right), ~~~ \text{if~}|b|u_h u_h^* < \omega^2.
\end{equation}
Equation~(\ref{eq:tails}) defines the tails of the reflection profile. As discussed previously, we made the selection of the right sign by imposing that the reflectivity tends to zero when $\omega^2 \rightarrow \infty$. The equation~(\ref{eq:totalreflection}) corresponds to the zone of total reflection. In fact, the reflection power or reflectance $\mathcal{R} (\theta)=|r(\theta)|^2 / |b|$ becomes
\begin{equation}\label{eq:Darwin}
\mathcal{R}_B^{\text{transparent, thick}} =
    \begin{cases} 
    1
    & \text{if  $|y| \le 1$},\\
    ( y - \sqrt{y^2-1} )^2
    & \text{if $|y|>1$},
    \end{cases}
\end{equation}
with $y=\omega/\sqrt{|b|u_h u_h^*}$. This is the so-called Darwin solution for the Bragg reflection. We recall that it was obtained by
i) consider the general reflectivity amplitude for the Bragg case [equation (\ref{eq:braggrandt})],
ii) consider the thick crystal $T\rightarrow \infty$ [equation (\ref{eq:thickbraggr})],
iii) apply zero-absorption [equations (\ref{eq:totalreflection},\ref{eq:tails})], and
iv) obtain the reflectance (reflecting power) by squaring the reflectivity amplitudes [equation (\ref{eq:Darwin})].
Another way to obtain the reflectance ends in the Ewald solution. The flowchart is \inblue{
i) consider the general reflectivity amplitude for the Bragg case [equation (\ref{eq:braggrandt})], ii) consider zero-absorption, 
iii) obtain the reflectance (reflecting power) $\mathcal{R}$, and
iv) consider its limit $T\rightarrow \infty$.}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Calculation of reflection and transmission amplitudes using the transfer matrix}

The matrix method permits to obtain the complex reflection and transmission amplitudes of a crystal made by layers of different crystals (or the same crystal with different orientations). For that,
i) construct the transfer matrix of the total crystal by multiplication\footnote{The multiplication should be done from bottom to top, i.e. $M=M_n M_{n-1}...M_2 M_1$}
of the transfer matrices of the different layers [each one calculated using equations~(\ref{eq:MtransferElements})];
ii) if geometry is Laue, obtain reflection and transmission amplitudes using the coefficients $m_{21}$ and $m_{11}$ of this matrix [equation~(\ref{eq:lauerandt})], respectively; otherwise (Bragg geometry), compute the scattering matrix using equation~(\ref{eq:scatteringMatrix}) and reflection and transmission amplitudes are given in the matrix terms $s_{21}$ and $s_{11}$ [equation~(\ref{eq:braggrandt})], respectively.

A first example shows how simple is to apply this recipe of multiplication of transfer matrices to get the reflectance of a simple two-layer crystal. Consider
a bilayer of two identical crystal layers of thickness $T$ and transfer matrix $M$ for each one. Using matrix analysis, the transfer matrix of the bilayer is $[M(T)]^2=M(2T)$ from which is easy to compute the reflectivity in Bragg geometry [equation~(\ref{eq:braggrandt})]. Otherwise, if this result would be obtained via the reflectivities ($r$ and $\bar{r}$) and transmittivities ($t$ and $\bar{t}$) of the single layer (S-matrix), the reflectivity of the bilayer results from an infinite series as shown in  Fig.~\ref{fig:doublelayer}.
 
\begin{figure}\label{fig:doublelayer}
    \centering
    \includegraphics[width=0.49\textwidth]{figures/figlayered2.pdf}
    \includegraphics[width=0.49\textwidth]{figures/doublelayer2.png}
    \caption{Example of calculation of the reflection amplitude $r_2$ of a Si 111 crystal of \SI{2}{\micro\meter} thickness from the amplitudes of the half-layer (\SI{1}{\micro\meter}). The reflectivity of the bilayer $r_2$ can be obtained as an infinite sum $r_2 = r + r t \bar{t} + r t \bar{t} (r \bar{r}) + r t \bar{t} (r \bar{r})^2 + ...= r[1 + t \bar{t}\sum_{n=0}^{\infty}(r\bar{r})^n]=r(1 + (t \bar{t} / (1-r \bar{r})))$. Calculations done with {\tt crystalpy} for a photon energy of 8 keV..}
\end{figure}


A second example is the Bragg reflection of a crystal layer on a thick substrate. The transfer matrix of the set $M'$ is calculated as
\begin{equation}
    M' = M^{\text{thick}} \times M,
\end{equation}
with $M^{\text{thick}}$ the transfer matrix of the substrate and $M$ the transfer matrix of the thin layer. We are interested in the Bragg reflectance or 
\begin{equation}
r_B=-\frac{m'_{21}}{m'_{22}}=
-\frac{m_{21}^{\text{thick}} m_{11} + m_{22}^{\text{thick}} m_{21}}
{m_{21}^{\text{thick}} m_{12} + m_{22}^{\text{thick}} m_{22}}.
\end{equation}
This can be expressed as a function of the substrate reflectance $r_S=-m_{21}^{\text{thick}}/m_{22}^{\text{thick}}$ giving: 
\begin{equation}
r_B=\frac{r_S m_{11} - m_{12}}
{m_{22}  - r_S m_{11}}.
\end{equation}

 The method of transfer matrix multiplication can also be used for analyzing distorted and bent crystals and will be explored in a future work.
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The direction of the incident and diffracted waves}\label{sec:directions}

In many applications, like in ray tracing, it is essential to know the \inblue{diffracted} wavevector $\textbf{k}_{\text{out}}$ that exits from the crystal. As mentioned before, the selection of the directions used to solve the TT equations contains some dose of arbitrariness. In our choice, $\textbf{k}_0$ vector corresponds exactly with the direction and wavelength of the incident ray or wave, which does not necessarily verify the Bragg law exactly.
The vector $\textbf{k}_h$ (see section~\ref{sec:TT}), defined  as $\textbf k_h=\textbf k_0 + \textbf h$, does not \inblue{correspond in general to} the wavevector of the outgoing ray or wave outside the crystal. The direction of the diffracted wave has the form 
\begin{equation}
    \textbf{k}_{\text{out}} = \textbf{k}_h + \beta \textbf{n}, \nonumber
\end{equation}
with $\textbf{n}$ the unit vector along the inward normal to the crystal surface. The (real) coefficient $\beta$ is obtained by writing that the modulus of $\textbf{k}_{\text{out}}$ is equal to $k$:
\begin{equation}
    |\textbf{k}_{\text{out}}|^2 = |\textbf{k}_h + \beta \textbf{n}|^2=k^2. \nonumber
\end{equation}
Note that $|\textbf{k}_h|^2=k^2(1-\alpha)$ and $\textbf{k}_h . \textbf{n} = k \gamma_h$, from which we obtain the equation
\begin{equation}
    k^2 = k^2(1-\alpha) + 2 k \gamma_h \beta + \beta^2. \nonumber
\end{equation}
Its solutions are
\begin{equation}
    \beta = - k \gamma_h \pm k \sqrt{\alpha + \gamma_h^2}. \nonumber
\end{equation}
The $\pm$ sign is chosen so that $\beta=0$ when $\alpha=0$. This implies 
\begin{equation}
    \beta = - k \left( \gamma_h  + \sqrt{\alpha + \gamma_h^2} \right)~~\text{in Laue case } (\gamma_h > 0), \nonumber
\end{equation}
and
\begin{equation}
    \beta = - k \left( \gamma_h  - \sqrt{\alpha + \gamma_h^2} \right) ~~\text{in Bragg case } (\gamma_h < 0). \nonumber
\end{equation}


% \todo{ REMOVE? 
% An alternative way to see it is to take into account i) the modulus of $\textbf{k}_{h,\text{out}}$ is the same as $\textbf{k}_0$, and ii) the component parallel to the crystal surface $\textbf{k}_{h,\text{out},||}$ must be equal to $\textbf{k}_{h,||}=\textbf{k}_{0,||} + \textbf{h}_{||}$ (continuity of the tangential component of the electric field at the crystal-vacuum interface).
% These conditions permit to determine how the perpendicular component of $\textbf{k}_{h,\text{out}}$ differs from $\textbf{k}_h$
% \begin{equation}
%     \textbf{k}_{h,\text{out}, \bot} = \kappa \textbf{k}_{h,\bot}, \nonumber
% \end{equation}
% with 
% \begin{equation}
%     \kappa^2 = \frac{|\textbf{k}_0|^2-|\textbf{k}_{h,||}|^2}
%     {|\textbf{k}_{h,\bot}|^2},
% \end{equation}
% which permits to construct $\textbf{k}_{h,\textbf{out}}=\textbf{k}_{h,\text{out},||}+\textbf{k}_{h,\text{out},\bot}=\textbf{k}_{h,||}+\kappa \textbf{k}_{h, \bot}$
% }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The {\tt crystalpy} library}
\label{sec:crystalpy}

{\tt Crystalpy} is a Python library that performs calculations on diffraction
from perfect crystals using the formalism introduced in the previous chapters.
% It also simulates the changes in the polarization state of the x-ray beam brought about by the diffraction using Müller-Stokes formalism. 
% The first version of this library was developed by Edoardo Cappelli, Mark Glass and Manuel Sanchez del Rio. 
The motivation of {\tt crystalpy} 
was to create a modern, extensible, well-documented, and friendly library to overcome the difficulties of integrating ancient software tools based on the dynamical diffraction theory. It is specifically designed for two objectives: support for new versions of the crystal diffraction codes delivered in platforms like OASYS \cite{codeOASYS}, and provide a core for ray tracing simulations with crystals.  
The {\tt crystalpy} library is written in the python language and uses standard libraries (numpy and scipy). It makes use of vector calculus and stack operations to accelerate the calculations. Therefore, it is adapted for being used in ray tracing tools, such as the future SHADOW~\cite{codeSHADOW} versions. 

To simulate a diffraction experiment using a perfect crystal, {\tt crystalpy}  offers functions that implement the theory described previously. Two input objects must be prepared: i) the incident wave(s) or  photon ray(s), and ii) the information on the crystal (diffraction setup). The objects representing these two entities are described here. 

The {\tt Photon} class is a minimum class for a photon, containing the energy (in eV) and a unit direction vector, implemented in 
the {\tt Vector} class. It deals with the storage and operations (addition, scalar product, cross product, normalization, rotation around an axis, etc.) of a 3D vector. A superclass of {\tt Photon} is {\tt ComplexAmplitudePhoton}, that contains the scalar complex amplitude for $\sigma$ and $\pi$ polarizations). 
These classes ({\tt Vector}, {\tt Photon} and {\tt ComplexAmplitudePhoton}) can hold stacks (the internal storage is done with arrays to speed-up vector operations). The {\tt ComplexAmplitidePhoton} classes 
has a corresponding {\tt ComplexAmplitudePhotonBunch} superclass, decorated with methods to deal with multiple waves or beams (bunches or sets of photons). 

The information on the crystal itself (e.g., particular crystal material and crystal structure), its preparation (crystal cut), and related physical parameters (like the structure factor) are managed by the {\tt DiffractionSetup} classes. {\tt Crystalpy} allows multiple options to retrieve the crystal structure and the scattering functions needed to calculate the structure factors. 
The {\tt DiffractionSetupAbstract} class defines the methods to access the basic information of the crystal (defined as a string, e.g. ``Si") such as {\tt angleBragg}, {\tt dSpacing}, and {\tt unitCellVolume}, and to compute the structure factors: {\tt F0}, {\tt FH}, {\tt FH\_bar}. These parameters can be obtained from several libraries external to {\tt crystalpy}. We implemented three options: i) {\tt DiffractionSetupXraylib} using the {\tt xraylib} library \cite{xraylib}, ii) {\tt DiffractionSetupDabax} that uses the DABAX library \cite{dabax}, and iii) using an ad-hoc generated data file. This modular structure permits disconnecting the calculation part from the access to optical and physical constants. Indeed, when using ad-hoc data files we do not have to import {\tt xraylib} or {\tt dabax} packages. We implemented this for the crystal material files of the SHADOW~\cite{codeSHADOW} code in the traditional version ({\tt DiffractionSetupShadowPreprocessorV1}), and in a more recent version \cite{Yu2022} supporting high d-spacing crystals ({\tt DiffractionSetupShadowPreprocessorV2}).
The {\tt DiffractionSetup} classes handle the information about the crystal setup and collects all the parameters needed to fully define the physical system we are modelling:
{\tt geometry\_type} (among {\tt BraggDiffraction, BraggTransmission, LaueDiffraction} and {\tt LaueTransmission}),
{\tt crystal\_name} (a string, e.g. Si, Ge),
{\tt thickness} (crystal thickness in SI units [m]),
{\tt miller\_h(,k,l)} (the Miller indices),
and {\tt asymmetry\_angle} (angle in degrees between the crystal surface and the planes $hkl$ as defined in \cite{codeCRYSTAL}).

To perform the main calculations (reflectivities, transfer matrices, diffracted photons, etc.) several methods in the {\tt Diffraction} class are used, getting the crystal setup and the photon bunch as inputs. For the moment, only flat perfect crystals are coded (in the {\tt PerfectCrystalDiffraction} class) which directly implements the formulation and theory in section~\ref{sec:TTsolutions}. For completeness, {\tt crystalpy} also includes the equations of the Zachariasen formalist~\cite{ZachariasenBook} and can be used instead of the ones described in this paper.
Typical angle or photon scans as shown in Fig.~\ref{fig:braggProfiles} are calculated defining a $\tt ComplexAmplitudePhoton$ entity for each point, group then in a {\tt ComplexAmplitudePhotonBunch} for then calculate the diffraction by the crystal using {\tt calculateDiffractedComplexAmplitudes}. \todo{listing?} 

A user-friendly application has been written in the OASYS environment to compute diffraction profiles using {\tt crystalpy} (Fig.~\ref{fig:xcrystal}). The applications automatically generates a script that can be used for further batch calculations. 

\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{figures/xcrystal.png}
    \caption{Interactive application for computing the perfect crystal diffraction profiles using {\tt crystalpy} and available in OASYS.  }
    \label{fig:xcrystal}
\end{figure}

In the ray tracing SHADOW4, all calculations related to crystal optics are delegated to  {\tt crystalpy}. Ray tracing permits simulations of beamline optics including a realistic description of the source. It also allows the simulation of curved crystals, under the assumption that the local reflectivity of the curved crystal is the same as for the flat crystal. This assumption is not always granted and has to be verified before ray tracing curved crystals. \todo{Example?}

% \todo{
% \begin{itemize}
%     \item a high numerical precision is required for calculating $\sin(aT)$, $\cos(aT)$ and $\exp(iT(u_0+\omega))$ for large values of T. This is  a typical problem when calculating Bragg reflection case using a large $t_c$. Can we make a recipe to switch to the "thick" crystal model for $t_c>t_{\text{eff}}$. How to calculate $t_{\text{eff}}$? 
% \end{itemize}
% }

% \begin{figure}
%     \centering
%     \includegraphics[width=0.8\textwidth]{figures/edo_sketch.png}
%     \caption{Schematic drawings of Bragg (left) and Laue (right) diffraction setups: \textbf{H} is the reciprocal vector associated with the $hkl$ family of lattice planes, also called the Bragg normal, $\theta_B$ is the Bragg angle and $\alpha_X$ is the asymmetry angle as discussed in \cite{codeCRYSTAL}.
%     \todo{change vector format (from arrows to bold)} }
%     \label{fig:edo_sketch}
% \end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Summary and conclusions}
\label{sec:summary}

We have presented a theoretical and numerical description of the dynamical diffraction in perfect crystals. In the first part of this paper, we presented a new perspective of the well-known dynamical theory of diffraction applied to undeformed perfect crystals. We deduced the equations of diffraction amplitudes (as well as intensity reflectance and transmittance) starting from basic principles via the solution of the Takagi-Taupin equations. We calculated the transfer matrix, useful to compute the diffraction of stacked crystal layers, and also the scattering matrix, of interest for the Bragg case. For completeness, our results are compared to those presented in the well-known textbook by \cite{ZachariasenBook} (see appendix~\ref{appendix:zachariasen}).
In the second part we presented {\tt crystalpy}, a software library completely written in python that implements the theory previously discussed. This open source tool can be used to predict the diffraction properties of any crystal structure, like Si, Ge or diamond typically used in synchrotron beamlines, but also for any other crystal provided its crystalline structure. This library is intended to replace multiple scattered pieces of software in packages like OASYS \cite{codeOASYS} and is designed to be the kernel of the crystal calculations in a new version of the SHADOW \cite{codeSHADOW} ray tracing code. The crystalpy library and its documentation are available from \url{https://github.com/oasys-kit/crystalpy}. 


\ack{Acknowledgements}
We recognize the work of Edoardo Cappelli and Mark Glass who developed the first version of {\tt crystalpy} implementing the theory in \cite{ZachariasenBook}. We acknowledge Ali Khounsary and Yujia Ding (CSRII, Illinois Institute of Technology, Chicago, IL 60616, USA) for helpful discussions on stacked crystals. 

\bibliography{iucr} % reads iucr.bib with items
\todo{Add Pinsker?}
\bibliographystyle{iucr}
%\referencelist{library}

\appendix

\section{Derivation of the TT equations for a rotating perfect crystal}
\label{appendix:rotating}

In the ``rotating crystal mode", the crystal is rotated around an axis perpendicular to the ``diffraction plane" which contains the diffraction vector $\textbf{h}$ and the wave-vector $\textbf{k}_0$ of the fixed incident plane-wave in vacuum. The crystal rotation from the exact geometrical Bragg position may be viewed as a special kind of crystal deformation. We propose to use the Takagi-Taupin approach to derive some basic results of the usual dynamic theory for perfect crystal diffraction. 

The x-ray wavefield inside the crystal is set as
\begin{subequations}
\label{eq:wavefieldappendix}
\begin{align}
        \Psi(\textbf r) = 
        e^{i \textbf k_0 . \textbf r} \left[
        A_0(\textbf r) + e^{i \textbf k_{B} . \textbf r} A_h(\textbf r)
        \right] = 
        \nonumber\\
        A_0(\textbf r) e^{i \textbf k_0 . \textbf r} + A_{h}(\textbf r) e^{i \textbf k_{hB} . \textbf r},
\end{align}
\end{subequations}
$\textbf{h}_B$ representing the diffraction vector in exact Bragg position. The vector $\textbf k_{hB}$  is therefore such that $|\textbf k_{0}|=|\textbf k_{hB}|=k=2 \pi / \lambda$. The Fourier coefficients $\chi_h$ of the perfect crystal susceptibility are replaced by the function $\chi_h \exp[i\textbf{k}_b.\textbf{u}(\textbf{r})]$, in which $\textbf{u}(\textbf{r})$ is the displacement field of the rotated crystal. The phase term $\exp[i\textbf{h}_B.\textbf{u}(\textbf{r})]$ will be written as $\exp(i\phi(\textbf{r})$. In such conditions, the following form of the TT equations
\begin{subequations}
\label{eq:TTvectorappendix}
\begin{align}
2 i \textbf{k}_0 . \nabla A_0 + \chi_0 k^2 A_0 + \chi_{-h} k^2 \exp(i\phi) A_h =& 0; \\
2 i \textbf{k}_{hB} . \nabla A_h + \chi_0 k^2 A_h + \chi_{h} k^2 \exp(-i\phi) A_0 =& 0,
\end{align}
\end{subequations}
is obtained by inserting this expression in the Helmholz equation~(\ref{eq:helmholz}), with the following approximations: the 2$^{\text{nd}}$-order derivatives of $A_{0,h}$ supposed to be slowly varying amplitudes are neglected and only the terms containing $\exp(i\textbf{k}_0.\textbf{r})$ in the product $\chi\Psi$ are considered. Introducing oblique coordinates $(s_0,s_h)$ in the diffraction plane, along the directions $\textbf{k}_0$ and $\textbf{k}_{hB}$, so that $\textbf{k}_0.\nabla A_0=k\frac{\partial A_0}{\partial s_0}$ and  $\textbf{k}_{hB}.\nabla A_h=k\frac{\partial A_h}{\partial s_h}$, the TT equations are
\begin{subequations}
\begin{align}
\frac{\partial A_0}{\partial s_0} =& \frac{ik}{2} \left[ \chi_0 A_0+ \chi_{-h} \exp(i\phi) A_h\right]; \\
\frac{\partial A_h}{\partial s_h} =& \frac{ik}{2} \left[ \chi_0 A_h+ \chi_{h} \exp(-\phi) A_0\right].
\end{align}
\end{subequations}

Performing the transformation $A_0=D_0$ and $\exp(i\phi) A_h=D_h$, we obtain
\begin{subequations}
\begin{align}
\frac{\partial D_0}{\partial s_0} =& \frac{ik}{2} \left[ \chi_0 D_0+ \chi_{-h} D_h\right]; \\
\frac{\partial D_h}{\partial s_h} =& \frac{ik}{2} \left[ (\chi_0 + \frac{2}{k}\frac{\partial\phi}{\partial s_h} ) D_h+ \chi_{h} D_0\right].
\end{align}
\end{subequations}
This is identical to equation~(\ref{eq:TT}) considering that $\alpha=\frac{2}{k}\frac{\partial\phi}{\partial s_h}$, which demonstration follows.

\subsection{Demonstration of $\alpha=\frac{2}{k}\frac{\partial\phi}{\partial s_h}$ }

Let $\textbf{i}_{0,h}$ be unit vectors along the directions of $\textbf{k}_0$ an $\textbf{k}_{hB}$; the crystal rotation $\Delta\theta=\theta-\theta_B$ transforms $\textbf{i}_{0,h}$ into $\textbf{j}_{0,h}$. A position vector $s_0\textbf{i}_0+s_h\textbf{i}_h$ is transformed into $s_0\textbf{j}_0+s_h\textbf{j}_h$. The displacement field is $\textbf{u}(s_0,s_h)=s_0(\textbf{j}_0-\textbf{i}_0)+ s_h(\textbf{j}_h-\textbf{i}_h)$; $\textbf{h}_B=k(\textbf{i}_h-\textbf{i}_0)$. Hence
\begin{equation}
    \phi(s_0,s_h)=\textbf{h}_B.\textbf{u}=k s_0(\textbf{i}_h-\textbf{i}_0).(\textbf{j}_0-\textbf{i}_0) + 
    k s_h(\textbf{i}_h-\textbf{i}_0).(\textbf{j}_h-\textbf{i}_h).
\end{equation}
We note that 
\begin{subequations}
\begin{align}
    \textbf{i}_0.\textbf{j}_0=\textbf{i}_h.\textbf{j}_h=&\cos\Delta\theta_B \\
    \textbf{i}_0.\textbf{j}_h=&\cos(2\theta_B +\Delta\theta) \\
    \textbf{i}_h.\textbf{j}_0=&\cos(2\theta_B -\Delta\theta) \\
    \textbf{i}_0.\textbf{i}_h=&\cos2\theta_B
\end{align}
\end{subequations}
therefore, 
\begin{subequations}
\begin{align}
    \frac{2}{k}\frac{\partial\phi}{\partial s_h} =  2(\textbf{i}_h-\textbf{i}_0).(\textbf{j}_h-\textbf{i}_h)&= \nonumber\\
    2(\cos\Delta\theta - \cos(2\theta_B+\Delta\theta)-1+\cos2\theta_B)&= \nonumber\\
    2[(\cos\Delta\theta-1)(1-\cos2\theta_B)+\sin2\theta_B\sin\Delta\theta]&=\nonumber\\
    4 \sin\theta_B[\sin\theta_B(\cos\Delta\theta-1)+\cos\theta_B\sin\Delta\theta]&=\nonumber\\
    4 \sin\theta_B[\sin(\theta_B+\Delta\theta)-\sin\theta_B]&\approx
    \alpha
\end{align}
\end{subequations}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Solutions of TT equations (\ref{eq:TTinB}) using the Laplace transform}
\label{appendix:laplace}


\subsubsection{Laue solution based on Laplace transform}
\label{sec:laplaceLaue}
Let denote $\bar{F}(p)$ the Laplace transform of a function $F(s)$
\begin{equation}
\Bar{F}(p) = \int_0^\infty ds \exp(-p s) F(s).
\end{equation}
Applying the Laplace transform to equations~(\ref{eq:TTinB}) we get
\begin{subequations}
\label{eq:TTlaueLaplace}
\begin{align}
(p + i \omega) \bar{B_0}(p) - i u_{-h} \bar{B_h}(p)= & 1 \\
(p - i \omega) \bar{B_h}(p) - i b u_{h} \bar{B_0}(p)= & 0.
\end{align}
\end{subequations}
The solutions are
\begin{subequations}
\begin{align}
\bar{B_0}(p) &= \frac{(p - i \omega) }{p^2 + a^2} \\
\bar{B_h}(p) &= \frac{i b u_h}{p^2 + a^2},
\end{align}
\end{subequations}
with, as previously defined, $a^2=\omega^2 + b u_h u_{-h}$, $a=\sqrt{\omega^2+b u_h u_{-h}}$
hence one retrieve the same results of equations (\ref{eq:BSolutions}) using the fact that  $(p^2+a^2)^{-1}$ and $p(p^2+a^2)^{-1}$ are the Laplace transform of $\sin(a s)/a$ and $\cos(a s)$, respectively. 

\subsubsection{Bragg solution based on Laplace transform}By Laplace transform of equation~(\ref{eq:TTinB}), and calling $r'=B_h(0)$, we obtain
\begin{subequations}
\label{eq:TTbraggLaplace}
\begin{align}
(p + i \omega) \bar{B_0}(p) - i u_{-h} \bar{B_h}(p)= & 1 \\
(p - i \omega) \bar{B_h}(p) - i u_{h} \bar{B_0}(p)= & r',
\end{align}
\end{subequations}
or 
\begin{subequations}
\begin{align}
\bar{B_0}(p) &= \frac{p - i \omega + i r u_{-h}}{p^2 + a^2} \\
\bar{B_h}(p) &= \frac{r' (p + i \omega) + i b u_h}{p^2 + a^2},
\end{align}
\end{subequations}
with (the same as before) $a^2=\omega^2+b u_h u_{-h}$. Hence:
\begin{subequations}
\begin{align}
B_0(s) &= \cos(a s) + i (r u_{-h} - \omega) \frac{\sin(a s)}{a}\\
B_h(s) &= r [\cos(a s) + i \omega \frac{\sin(a s)}{a}] + i b u_h \frac{\sin(a s)}{a}.
\end{align}
\end{subequations}

The $r'$ and then the reflected and transmitted amplitudes are obtained using the condition $D_h(T)=B_h(T)=0$. With some calculation, we obtain: 
\begin{subequations}
\begin{align}
r=\frac{D_h(0)}{D_0(0)} =& B_h(0) = r' = \frac{-i b u_h \sin(a T)}{a \cos(a T) + i\omega \sin(a T)}\\
t =\frac{D_0(T)}{D_0(0)}= & B_0(T) ~ \exp(i T (u_0+\omega)) = \frac{a~\exp(i T (u_0+\omega))}{a \cos(a T) + i\omega \sin(a T)} ,
\end{align}
\end{subequations}
with $a=\sqrt{\omega^2 + b u_h u_{-h}}$, and  
$T=t_c/\cos(\theta_0)$ with $t_c$ the crystal thickness.

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \section{Bragg amplitudes when beam enters from the back of the crystal}
% \label{sec:braggfromtheback}
% It is useful to calculate the reflectance and transmitted amplitudes when the beam enters from the back along the $\textbf{k}_h$ direction for then build the amplitudes of a layered crystal (matrix method). 

% \subsubsection{Bragg case:} the entrance surface is $s=T$ and the exit is $s=0$. The boundary conditions are $B_h(T)=1$ and $B_0(0)=0$. From equations~(\ref{sec:TTsolutions}) we get
% \begin{subequations}
% \begin{align}
% c_1 = \frac{1}{\xi_1 \exp(i a T) - \xi_2 \exp(-i a T)}\\
% c_2 = \frac{-1}{\xi_1 \exp(i a T) - \xi_2 \exp(-i a T)},
% \end{align}
% \end{subequations}
% and 
% \begin{subequations}
% \begin{align}
% B_0(T) = &c_1 \exp{i a T} + c_2 \exp(-i a T)=
% \frac{i u_{-h} \sin(a T)}{a \cos(a T)+ i \omega \sin(a T)}\\
% B_h(0) = &c_1 \xi_1 + c_2 \xi_2=
% \frac{a}{a \cos(a T)+ i \omega \sin(a T)}.
% \end{align}
% \end{subequations}
% In consequence
% \begin{subequations}
% \label{eq:braggrbarandtbar}
% \begin{align}
% \bar r = \frac{D_0(T)}{D_h(T)} = &
% \frac{i u_{-h} \sin(a T)}{a \cos(a T)+ i \omega \sin(a T)}\\
% \bar t = \frac{D_h(0)}{D_h(T)} = &
% \frac{a ~ \exp(-i T (u_0+\omega))}{a \cos(a T)+ i \omega \sin(a T)} .
% \end{align}
% \end{subequations}
% As compared with equations~(\ref{eq:braggrandt}) we see now that $-b$ does not appear in $\bar r$, there us $u_{-h}$ instead of $u_h$ and there is a different sign in the exponential of the numerator in $\bar t$. 

\section{Equivalence of amplitudes in equations (\ref{eq:braggrandt}) and (\ref{eq:lauerandt}) with Zachariasen theory.}
\label{appendix:zachariasen}

In \cite{ZachariasenBook}, the diffracted and transmitted amplitudes for a single perfect parallel-sided crystal of thickness $T$ in Laue case are (equations [3.130] and [3.131] in \cite{ZachariasenBook}):
 	\begin{subequations}
    \label{eq:ZacLaue}
    \begin{align}
    r^Z_L &= \frac{x_1 x_2 (c_1 - c_2)}{x_2-x_1}, \\
    t^Z_L &= \frac{x_2 c_1 - x_1 c_2}{x_2-x_1},
    \end{align}
	\end{subequations}
and for Bragg case\footnote{Note that in equation~(\ref{eq:ZacBragg}a) we write $(c_2-c_1)$ rather than $(c_1-c_2)$ as in Zachariasen's book. This does not affect the result shown by Zachariasen as the amplitudes are squared to give intensities. However, for calculating the amplitudes, the correct sign (as shown here) is important.} (equations [3.137] and [3.138]) 
	\begin{subequations}
	\label{eq:ZacBragg}
    \begin{align}
	r^Z_{B} &=  
	\frac{x_1 x_2 (c_2 - c_1)}{c_2 x_2-c_1 x_1}, \\
 	t^Z_{B} &=  
	\frac{c_1 c_2 (x_1 - x_2)}{c_2 x_2-c_1 x_1},    
    \end{align}
    \end{subequations}


where
\begin{subequations}
\begin{align}
c_{1,2} &=\exp(-i \phi_{1,2} T), \\
\phi_1 &= 2\pi k \delta'_0/\gamma_0, \\
\phi_2 &= 2\pi k \delta''_0/\gamma_0,
\end{align}
\end{subequations}
$\gamma_0$ ($\gamma_h$) is the direction cosine of the incident (diffracted) 
wave and the other quantities are defined as:
\begin{subequations}
\begin{align}
	\left( \begin{array}{ll}
               \delta_0' \\
               \delta_0''
	       \end{array} 
	\right)
	&= \frac{1}{2} \left( \Psi_0 - z\pm X \right)
\\
    x_{1,2}
	&= \frac{- z\pm X}{\Psi_{\bar{H}}}
 \\
	z &= \frac{1-b}{2} \Psi_0 + \frac{b}{2} \alpha_Z 
 \\
	\alpha_Z &= \frac{1}{|\vec{k}_0|^2} 
              \left[ |\vec{B_H}|^2 +
	       2 \vec{k}_0 \cdot \vec{B_H} \right],
\end{align}
\end{subequations}
with $X=\sqrt{q+z^2}$, $q=b\Psi_H\Psi_{\bar{H}}$ , 
% $\tau \simeq 2 \Delta \sin(2 \theta_B)$,
% $P$ is the polarization factor,
$\Psi_H$ is the Fourier component of the
electrical susceptibility $\Psi_0$ and $b=\gamma_0/\gamma_h$ is the asymmetry
factor.

It is easy to see that $x_2-x_1=2 X / (\inred{P}\Psi_{\bar{H}})$, $x_1 x_2 = -b \Psi_H/(\Psi_{\bar{H}} \inred{/P^2})$, and 
\begin{equation}
  c_{1,2} = \exp
  \left(-i\frac{2 \pi k_0 t}{\gamma_0} \frac{1}{2} (\Psi_0-z \pm X)\right)\equiv c \exp(\pm i m), 
\end{equation}
where we introduced the variables $c=\exp(-i2\pi k_0 t  (\Psi_0-z)) / (2 \gamma_0)$ and $m=-2\pi k_0 t X / (2 \gamma_0)$. We then have
\begin{equation}
    c_1-c_2=c(e^{im}-e^{-im})=2ic \sin(m), 
\end{equation}
and
\begin{equation}
    x_2 c_1 - x_1 c_2 = \frac{c}{\inred{P} \Psi_{\bar{H}}} \left[ 
 -(X+z)e^{im}-(X-z)e^{-im}\right] =
 \frac{2 c}{\inred{P} \Psi_{\bar{H}}}(-X \cos(m) - i z \sin(m)).
\end{equation}
Replacing in equation~(\ref{eq:ZacBragg}) the terms obtained here  we finally get:
	\begin{subequations}
	\label{eq:ZacBragg2}
    \begin{align}
	r^Z_{L} &=  i c b \inred{P} \Psi_H \frac{\sin(m)}{X}, \\
 	t^Z_{L} &= c [\cos(m) + i\frac{z}{X} \sin(m)].   
    \end{align}
    \end{subequations}

For the Bragg case, we precalculate
\begin{equation}
    x_2 c_2 - x_1 c_1 = \frac{c}{\inred{P} \Psi_{\bar{H}}} \left[ 
 -(X+z)e^{-im}-(X-z)e^{im}\right] =
 \frac{2c}{\inred{P} \Psi_{\bar{H}}}(-X \cos(m) + \inred{i} z \sin(m)),
\end{equation}
that introduced in equation~(\ref{eq:ZacBragg}) we finally get:

	\label{eq:ZacLaue2}
    \begin{subequations}
    \begin{align}
	r^Z_{B} &=  i b \Psi_H \frac{\sin(m)}{ - X \cos(m) + \inred{i} z \sin(m)}, \\
 	t^Z_{B} &= \frac{ -c X}{-X \cos(m) + \inred{i} z \sin(m)}.   
    \end{align}
    \end{subequations}

Considering the equivalence of notations between this work and Zachariasen' book (see Table 1), we can verify that equations~(\ref{eq:ZacLaue}) are identical to (\ref{eq:lauerandt}) and, similarly,  equations~(\ref{eq:ZacBragg}) are identical to (\ref{eq:braggrandt}).

\begin{table}
\caption{Equivalences in notation of this work and \cite{ZachariasenBook}}
    \begin{center}
\begin{tabular}{ll}      % Alignment for each cell: l=left, c=center, r=right
 Zachariasen    & This work     \\
\hline
$\exp(-2\pi i \textbf{k}_0.\textbf{r})$ & $\exp(i\textbf{k}.\textbf{r})$      \\
 $k_0=1/\lambda$ & $k=2 \pi / \lambda$      \\
 $\alpha_Z$      & $-\alpha$                \\
 $\Psi_0$      & $\chi_0$                 \\
 $\Psi_H$      & $\chi_h$                 \\
 $z$           & $-(\lambda/\pi) \omega$  \\
 $X$           & $(\lambda/\pi) a$        \\
 $t_0$         & $t_c=T/\gamma_0$         \\
 \inred{$m$}           & $a T$                    \\
 $c$  & $\exp(i T (u_0+\omega))$   
 \end{tabular}
     \end{center}
\end{table}


% \section{Derivation of the Lens Equation from the phase-factor of the Takagi-Taupin equations}
% \label{appendix:CLE}





     %-------------------------------------------------------------------------
     % The back matter of the paper - acknowledgements and references
     %-------------------------------------------------------------------------

     % Acknowledgements come after the appendices



     % References are at the end of the document, between \begin{references}
     % and \end{references} tags. Each reference is in a \reference entry.

%\begin{references}
%\reference{Author, A. \& Author, B. (1984). \emph{Journal} \textbf{Vol}, first page--last page.}
%\end{references}
%\cite{knuth84}

%\begin{thebibliography}{30}
%\expandafter\ifx\csname natexlab\endcsname\relax\def\natexlab#1{#1}\fi
%\expandafter\ifx\csname bibnamefont\endcsname\relax
%  \def\bibnamefont#1{#1}\fi
%\expandafter\ifx\csname bibfnamefont\endcsname\relax
%  \def\bibfnamefont#1{#1}\fi
%\expandafter\ifx\csname citenamefont\endcsname\relax
%  \def\citenamefont#1{#1}\fi
%\expandafter\ifx\csname url\endcsname\relax
%  \def\url#1{\texttt{#1}}\fi
%\expandafter\ifx\csname urlprefix\endcsname\relax\def\urlprefix{URL }\fi
%\providecommand{\bibinfo}[2]{#2}
%\providecommand{\eprint}[2][]{\url{#2}}
%
%\bibitem[{\citenamefont{Shvyd'ko}(2016)}]{GuigayFerrero2013}
%\bibinfo{author}{\bibfnamefont{Yu.}~\bibnamefont{Shvyd'ko}},
%\bibinfo{journal}{Phys. Rev. Lett.} \textbf{\bibinfo{volume}{116}},
%\bibinfo{pages}{080801} (\bibinfo{year}{2016}).
%
%%\bibitem[{\citenamefont{Guigay and Ferrero}]{ddd}
%%\bibinfo{author}{\bibfnamefont{Jean-Pierre}~\bibnamefont{Guigay}},
%%\bibinfo{author}{\bibfnamefont{Claudio}~\bibnamefont{Ferrero}},
% % \bibinfo{journal}{xxxx} \textbf{\bibinfo{volume}{xx}},
% % \bibinfo{pages}{xx} (\bibinfo{year}{2012}).
%
%\end{thebibliography}

%% Note added by Overleaf: If using bibtex, remove the "references" environment above, and uncomment the following lines.

%\bibliographystyle{iucr}
%\referencelist{iucr}

%      %-------------------------------------------------------------------------
%      % TABLES AND FIGURES SHOULD BE INSERTED AFTER THE MAIN BODY OF THE TEXT
%      %-------------------------------------------------------------------------
% 
%      % Simple tables should use the tabular environment according to this
%      % model
% 
% \begin{table}
% \caption{Caption to table}
% \begin{tabular}{llcr}      % Alignment for each cell: l=left, c=center, r=right
%  HEADING    & FOR        & EACH       & COLUMN     \\
% \hline
%  entry      & entry      & entry      & entry      \\
%  entry      & entry      & entry      & entry      \\
%  entry      & entry      & entry      & entry      \\
% \end{tabular}
% \end{table}
% 
%      % Postscript figures can be included with multiple figure blocks
% 
% \begin{figure}
% \caption{Caption describing figure.}
% \includegraphics{fig1}
% \end{figure}


\end{document}                    % DO NOT DELETE THIS LINE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
